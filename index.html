<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Simulator</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --page-width: 420px;
            --page-height: 600px;
            --sidebar-width: 280px;
            --toolbar-width: 80px;
        }

        body {
            font-family: 'Crimson Text', 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* Burger Menu Button */
        .burger-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        .burger-btn:hover {
            transform: scale(1.05);
        }

        .burger-btn .material-icons {
            font-size: 28px;
            color: #333;
        }

        /* Left Sidebar */
        .left-sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: #2c3e50;
            color: white;
            padding: 80px 20px 20px 20px;
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        }

        .left-sidebar.open {
            left: 0;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            outline: none;
        }

        .page-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .page-item {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .page-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .page-item.active {
            background: #3498db;
        }

        .page-item.has-highlight {
            background: rgba(241, 196, 15, 0.3);
            border: 2px solid #f1c40f;
        }

        /* Right Toolbar */
        .right-toolbar {
            position: fixed;
            right: 0;
            top: 0;
            width: var(--toolbar-width);
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            z-index: 100;
            padding: 20px 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .toolbar-btn {
            width: 50px;
            height: 50px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #555;
        }

        .toolbar-btn:hover {
            background: #f0f0f0;
            color: #3498db;
        }

        .toolbar-btn .material-icons {
            font-size: 24px;
        }

        .toolbar-separator {
            width: 40px;
            height: 1px;
            background: #ddd;
            margin: 5px 0;
        }

        .font-select, .font-size-select {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            margin: 5px 0;
        }

        .color-input {
            width: 50px;
            height: 40px;
            border: none;
            cursor: pointer;
            border-radius: 6px;
        }

        /* Book Container */
        .book-container {
            display: flex;
            gap: 40px;
            perspective: 1500px;
            z-index: 10;
        }

        .page {
            width: var(--page-width);
            height: var(--page-height);
            background: #fffef7;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        .page-left {
            transform-origin: right center;
            border-right: 1px solid #e0e0e0;
        }

        .page-right {
            transform-origin: left center;
            border-left: 1px solid #e0e0e0;
        }

        .page-content {
            width: 100%;
            height: calc(100% - 40px);
            outline: none;
            font-size: 16px;
            line-height: 1.8;
            overflow: hidden;
            word-wrap: break-word;
        }

        .page-number {
            position: absolute;
            bottom: 15px;
            font-size: 12px;
            color: #999;
        }

        .page-left .page-number {
            left: 40px;
        }

        .page-right .page-number {
            right: 40px;
        }

        /* Search highlight styling */
        mark.search-highlight {
            background-color: #ffeb3b;
            color: #000;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
        }

        /* Navigation Controls */
        .nav-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }

        .page-input {
            width: 50px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Action Buttons */
        .action-btn {
            width: 60px;
            padding: 8px;
            font-size: 11px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.2s;
        }

        .btn-add {
            background: #2ecc71;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-save {
            background: #9b59b6;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            :root {
                --page-width: 350px;
                --page-height: 500px;
            }
            
            .book-container {
                gap: 20px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Burger Menu Button -->
    <button class="burger-btn" id="burgerBtn">
        <i class="material-icons">menu</i>
    </button>

    <!-- Left Sidebar -->
    <div class="left-sidebar" id="leftSidebar">
        <input type="text" class="search-box" id="searchBox" placeholder="Search in book...">
        <div class="page-list" id="pageList"></div>
    </div>

    <!-- Right Toolbar -->
    <div class="right-toolbar">
        <!-- Navigation -->
        <div class="nav-controls">
            <button class="toolbar-btn" id="prevBtn" title="Previous Spread (Left Arrow)">
                <i class="material-icons">arrow_back</i>
            </button>
            <input type="number" class="page-input" id="pageInput" min="1" value="1">
            <button class="toolbar-btn" id="nextBtn" title="Next Spread (Right Arrow)">
                <i class="material-icons">arrow_forward</i>
            </button>
        </div>

        <div class="toolbar-separator"></div>

        <!-- Font Controls -->
        <select class="font-select" id="fontFamily" title="Font Family">
            <option value="'Crimson Text', Georgia, serif">Crimson</option>
            <option value="'Calibri', Arial, sans-serif">Calibri</option>
            <option value="'Times New Roman', serif">Times</option>
            <option value="'Arial', sans-serif">Arial</option>
            <option value="'Georgia', serif">Georgia</option>
            <option value="'Courier New', monospace">Courier</option>
        </select>

        <select class="font-size-select" id="fontSize" title="Font Size">
            <option value="12px">12</option>
            <option value="14px">14</option>
            <option value="16px" selected>16</option>
            <option value="18px">18</option>
            <option value="20px">20</option>
            <option value="24px">24</option>
        </select>

        <div class="toolbar-separator"></div>

        <!-- Text Formatting -->
        <button class="toolbar-btn" data-command="bold" title="Bold">
            <i class="material-icons">format_bold</i>
        </button>
        <button class="toolbar-btn" data-command="italic" title="Italic">
            <i class="material-icons">format_italic</i>
        </button>
        <button class="toolbar-btn" data-command="underline" title="Underline">
            <i class="material-icons">format_underlined</i>
        </button>

        <div class="toolbar-separator"></div>

        <!-- Text Alignment -->
        <button class="toolbar-btn" data-command="justifyLeft" title="Align Left">
            <i class="material-icons">format_align_left</i>
        </button>
        <button class="toolbar-btn" data-command="justifyCenter" title="Center">
            <i class="material-icons">format_align_center</i>
        </button>
        <button class="toolbar-btn" data-command="justifyRight" title="Align Right">
            <i class="material-icons">format_align_right</i>
        </button>

        <div class="toolbar-separator"></div>

        <!-- Color Picker -->
        <input type="color" class="color-input" id="textColor" value="#000000" title="Text Color">

        <div class="toolbar-separator"></div>

        <!-- Actions -->
        <button class="action-btn btn-add" id="addSpreadBtn" title="Add Spread at End">+ ADD</button>
        <button class="action-btn btn-delete" id="deleteSpreadBtn" title="Delete Current Spread">DELETE</button>
        <button class="action-btn btn-save" id="saveBtn" title="Export as PDF">PDF</button>
    </div>

    <!-- Book Pages -->
    <div class="book-container">
        <div class="page page-left" id="leftPage">
            <div class="page-content" contenteditable="true" id="leftContent"></div>
            <div class="page-number" id="leftNumber">1</div>
        </div>
        <div class="page page-right" id="rightPage">
            <div class="page-content" contenteditable="true" id="rightContent"></div>
            <div class="page-number" id="rightNumber">2</div>
        </div>
    </div>

    <script>
        // Book State
        let bookPages = [];
        let currentSpread = 0;
        let currentSearchQuery = '';
        const STORAGE_KEY = 'bookSimulatorContent';

        // Default story content
        const defaultStory = [
            `<h2>Chapter 1 — The Letter by the Sea</h2>
<p>The day had begun as plain as warm bread and wind. The horizon stretched silver and quiet, and gulls drew uneven circles above the old fishing pier.</p>
<p>Elara had walked this beach every dawn for a year, waiting for a sign that never came. Her brother had vanished in the storm that swallowed three boats last winter, and though the sea had returned ropes, barrels, and one broken oar, it had never returned him. Still, she walked.</p>
<p>That morning the tide left something new—a sealed letter wrapped in seaweed, its wax as red as a drop of blood. It lay half‑buried beside her footprints.</p>
<p><em>To the one who still watches the horizon</em>, the letter read in ink faded by salt.</p>`,
            `<p>When she broke the seal open, her pulse faltered. Inside was one line, uneven and hurried:<br><em>When the lighthouse goes dark, follow the music.</em></p>
<p>All day she turned the words over. The lighthouse hadn't gone dark in fifty years, not since her father maintained it, not since before the sea began keeping secrets.</p>
<p>But at twilight, when the clouds folded low and gulls hid themselves in fog, the beam atop the old tower sputtered once—twice—and died.</p>`,
            `<h2>Chapter 2 — The Song Beneath the Waves</h2>
<p>The ocean at night looked almost alive, breathing slow and deep. Elara rowed into it, the lantern on her prow swinging in rhythm with her heartbeat.</p>
<p>Her father used to say the sea had moods. Tonight it was listening.</p>
<p>The melody rose out of the fog first as vibration—a half‑heard hum running down her bones. Then came the notes: low, tremulous, like a violin being played somewhere in the deep. The sound drifted from the direction of the lighthouse, and though every sensible part of her begged her to turn back, she kept rowing.</p>`,
            `<p>The tower's shadow loomed, jagged and black. Its base was now half‑submerged, waves lapping over steps that once led to the old keeper's door. She tied her boat to what remained of the railing and climbed, one wet stone at a time. Inside, broken lenses gleamed faintly in the lantern light.</p>
<p>Water covered the floor. And there, floating upright in the flooded chamber, was a violin. Its strings shimmered though no one played them, and around it, the glow of her lantern bent as if drawn toward the sound.</p>
<p>When her fingertips brushed the neck of the violin, her breath caught. Images burst under her skin: a younger version of her brother laughing on that very pier, her father tuning the tower's great lens to the rhythm of waves, and storms that ended not with wrecks—but with music.</p>
<p>Then the light collapsed all at once, leaving her in darkness thick and humming.</p>`,
            `<h2>Chapter 3 — The Keeper's Promise</h2>
<p>When she woke, the sky outside the tower was streaked rose and violet. The sun was rising again, but something in the world had shifted. The clock above the door ticked backward for a single breath before righting itself.</p>
<p>Elara stood at the railing, her lantern relit, but the flame burned silver now instead of gold. In her other hand she held the violin—silent, but warm. The lighthouse lens caught the morning's first light and sent it out across the sea, turning the horizon molten.</p>`,
            `<p>She had not found a body, nor a ghost. What she found was continuity: sound woven into sea‑foam, voices folded into mist. The light she re‑kindled shone steadier than before, beating with her own pulse.</p>
<p>From that day, sailors spoke of a beacon that sang. They said its glow moved with the rhythm of waves, like a heartbeat under the ocean's skin.</p>
<p>And sometimes, at dawn, when the tide curled just low enough, a letter would drift ashore again—ink washed thin, seal cracked by salt—waiting for the next soul who refused to stop watching the horizon.</p>
<p><em>Addressed to: whoever still hears the song.</em></p>`
        ];

        // Initialize
        function init() {
            loadBook();
            updateDisplay();
            attachEventListeners();
        }

        // Load book from storage or create default pages
        function loadBook() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                bookPages = JSON.parse(saved);
            } else {
                bookPages = [...defaultStory];
            }
        }

        // Save book to storage
        function saveBook() {
            // Remove highlights before saving
            const cleanPages = bookPages.map(page => 
                page.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1')
            );
            localStorage.setItem(STORAGE_KEY, JSON.stringify(cleanPages));
        }

        // Highlight search terms in content
        function highlightSearchTerms(content, query) {
            if (!query) return content;
            
            // Remove existing highlights
            content = content.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1');
            
            // Add new highlights
            const regex = new RegExp(`(${query})`, 'gi');
            return content.replace(regex, '<mark class="search-highlight">$1</mark>');
        }

        // Update display
        function updateDisplay() {
            const leftContent = document.getElementById('leftContent');
            const rightContent = document.getElementById('rightContent');
            const leftNumber = document.getElementById('leftNumber');
            const rightNumber = document.getElementById('rightNumber');
            const pageInput = document.getElementById('pageInput');

            // Update left page
            if (currentSpread < bookPages.length) {
                let content = bookPages[currentSpread] || '';
                if (currentSearchQuery) {
                    content = highlightSearchTerms(content, currentSearchQuery);
                }
                leftContent.innerHTML = content;
                leftNumber.textContent = currentSpread + 1;
                leftContent.contentEditable = true;
            }

            // Update right page
            if (currentSpread + 1 < bookPages.length) {
                let content = bookPages[currentSpread + 1] || '';
                if (currentSearchQuery) {
                    content = highlightSearchTerms(content, currentSearchQuery);
                }
                rightContent.innerHTML = content;
                rightNumber.textContent = currentSpread + 2;
                rightContent.contentEditable = true;
            } else {
                rightContent.innerHTML = '';
                rightNumber.textContent = '';
                rightContent.contentEditable = false;
            }

            pageInput.value = currentSpread + 1;
            updatePageList();
        }

        // Update page list in sidebar
        function updatePageList() {
            const pageList = document.getElementById('pageList');
            pageList.innerHTML = '';

            for (let i = 0; i < bookPages.length; i += 2) {
                const item = document.createElement('div');
                item.className = 'page-item';
                if (i === currentSpread) {
                    item.classList.add('active');
                }

                // Check if this spread has search matches
                if (currentSearchQuery) {
                    const leftText = (bookPages[i] || '').toLowerCase();
                    const rightText = (bookPages[i + 1] || '').toLowerCase();
                    if (leftText.includes(currentSearchQuery.toLowerCase()) || 
                        rightText.includes(currentSearchQuery.toLowerCase())) {
                        item.classList.add('has-highlight');
                    }
                }

                const leftNum = i + 1;
                const rightNum = (i + 1 < bookPages.length) ? i + 2 : '';
                const range = rightNum ? `${leftNum}-${rightNum}` : `${leftNum}`;
                
                const preview = (bookPages[i] || '').replace(/<[^>]*>/g, '').substring(0, 40);
                item.innerHTML = `<strong>Pages ${range}</strong><br><small>${preview}...</small>`;
                
                item.onclick = () => {
                    currentSpread = i;
                    updateDisplay();
                    document.getElementById('leftSidebar').classList.remove('open');
                };

                pageList.appendChild(item);
            }
        }

        // Handle text overflow
        function handleOverflow(contentEl, pageIndex) {
            const container = contentEl;
            
            if (container.scrollHeight > container.clientHeight) {
                let html = container.innerHTML;
                let tempDiv = document.createElement('div');
                tempDiv.style.width = container.clientWidth + 'px';
                tempDiv.style.height = container.clientHeight + 'px';
                tempDiv.style.position = 'absolute';
                tempDiv.style.visibility = 'hidden';
                tempDiv.style.overflow = 'hidden';
                document.body.appendChild(tempDiv);

                let overflowHTML = '';
                tempDiv.innerHTML = html;

                while (tempDiv.scrollHeight > tempDiv.clientHeight && tempDiv.childNodes.length > 0) {
                    const lastChild = tempDiv.lastChild;
                    if (lastChild.outerHTML) {
                        overflowHTML = lastChild.outerHTML + overflowHTML;
                    } else {
                        overflowHTML = lastChild.textContent + overflowHTML;
                    }
                    tempDiv.removeChild(lastChild);
                }

                document.body.removeChild(tempDiv);

                bookPages[pageIndex] = tempDiv.innerHTML;
                container.innerHTML = tempDiv.innerHTML;

                const nextPageIndex = pageIndex + 1;
                if (nextPageIndex >= bookPages.length) {
                    bookPages.push(overflowHTML);
                    bookPages.push('');
                } else {
                    bookPages[nextPageIndex] = overflowHTML + (bookPages[nextPageIndex] || '');
                }

                saveBook();
                updateDisplay();

                if (pageIndex === currentSpread + 1) {
                    setTimeout(() => {
                        currentSpread += 2;
                        updateDisplay();
                        document.getElementById('leftContent').focus();
                    }, 100);
                }
            }
        }

        // Format text
        function formatText(command, value = null) {
            document.execCommand(command, false, value);
        }

        // Export to PDF
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 20;
            const pageHeight = 280;
            const margin = 20;
            const maxWidth = 170;

            for (let i = 0; i < bookPages.length; i++) {
                // Remove HTML tags and get plain text
                let text = bookPages[i].replace(/<[^>]*>/g, '');
                // Remove search highlights
                text = text.replace(/\s+/g, ' ').trim();
                
                if (text) {
                    // Add page number
                    doc.setFontSize(10);
                    doc.text(`Page ${i + 1}`, margin, yPosition);
                    yPosition += 10;
                    
                    // Add content
                    doc.setFontSize(12);
                    const lines = doc.splitTextToSize(text, maxWidth);
                    
                    for (let line of lines) {
                        if (yPosition > pageHeight) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.text(line, margin, yPosition);
                        yPosition += 7;
                    }
                    
                    // Add spacing between pages
                    yPosition += 15;
                    
                    if (yPosition > pageHeight - 20) {
                        doc.addPage();
                        yPosition = 20;
                    }
                }
            }
            
            doc.save('my-book.pdf');
        }

        // Attach event listeners
        function attachEventListeners() {
            // Burger menu
            document.getElementById('burgerBtn').onclick = () => {
                document.getElementById('leftSidebar').classList.toggle('open');
            };

            // Navigation with arrow keys
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'text') return;
                
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    document.getElementById('prevBtn').click();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    document.getElementById('nextBtn').click();
                }
            });

            // Navigation buttons
            document.getElementById('prevBtn').onclick = () => {
                if (currentSpread >= 2) {
                    saveCurrentPages();
                    currentSpread -= 2;
                    updateDisplay();
                }
            };

            document.getElementById('nextBtn').onclick = () => {
                if (currentSpread + 2 < bookPages.length) {
                    saveCurrentPages();
                    currentSpread += 2;
                    updateDisplay();
                }
            };

            document.getElementById('pageInput').onchange = (e) => {
                let page = parseInt(e.target.value) - 1;
                if (page % 2 !== 0) page--;
                if (page >= 0 && page < bookPages.length) {
                    saveCurrentPages();
                    currentSpread = page;
                    updateDisplay();
                }
            };

            // Toolbar buttons
            document.querySelectorAll('.toolbar-btn[data-command]').forEach(btn => {
                btn.onclick = () => formatText(btn.dataset.command);
            });

            // Font controls
            document.getElementById('fontFamily').onchange = (e) => {
                formatText('fontName', e.target.value);
            };

            document.getElementById('fontSize').onchange = (e) => {
                document.execCommand('fontSize', false, '7');
                document.querySelectorAll('font[size="7"]').forEach(el => {
                    el.removeAttribute('size');
                    el.style.fontSize = e.target.value;
                });
            };

            document.getElementById('textColor').onchange = (e) => {
                formatText('foreColor', e.target.value);
            };

            // Content editing
            const leftContent = document.getElementById('leftContent');
            const rightContent = document.getElementById('rightContent');

            leftContent.addEventListener('input', () => {
                setTimeout(() => handleOverflow(leftContent, currentSpread), 0);
            });

            rightContent.addEventListener('input', () => {
                setTimeout(() => handleOverflow(rightContent, currentSpread + 1), 0);
            });

            // Paste handling
            [leftContent, rightContent].forEach((el, idx) => {
                el.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const text = e.clipboardData.getData('text/html') || e.clipboardData.getData('text/plain');
                    document.execCommand('insertHTML', false, text);
                    setTimeout(() => handleOverflow(el, currentSpread + idx), 0);
                });
            });

            // Add spread
            document.getElementById('addSpreadBtn').onclick = () => {
                saveCurrentPages();
                bookPages.push('', '');
                saveBook();
                alert('New spread added at the end!');
                updateDisplay();
            };

            // Delete spread
            document.getElementById('deleteSpreadBtn').onclick = () => {
                if (bookPages.length <= 2) {
                    alert('Cannot delete the last spread!');
                    return;
                }
                if (confirm('Delete current spread?')) {
                    bookPages.splice(currentSpread, 2);
                    if (currentSpread >= bookPages.length) {
                        currentSpread = Math.max(0, bookPages.length - 2);
                    }
                    saveBook();
                    updateDisplay();
                }
            };

            // Save/Export to PDF
            document.getElementById('saveBtn').onclick = () => {
                saveCurrentPages();
                exportToPDF();
            };

            // Search with highlighting
            document.getElementById('searchBox').addEventListener('input', (e) => {
                currentSearchQuery = e.target.value.trim();
                updateDisplay();
            });
        }

        // Save current visible pages
        function saveCurrentPages() {
            // Remove highlights before saving
            const leftHTML = document.getElementById('leftContent').innerHTML;
            const rightHTML = document.getElementById('rightContent').innerHTML;
            
            bookPages[currentSpread] = leftHTML.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1');
            if (currentSpread + 1 < bookPages.length) {
                bookPages[currentSpread + 1] = rightHTML.replace(/<mark class="search-highlight">(.*?)<\/mark>/gi, '$1');
            }
            saveBook();
        }

        // Auto-save before leaving
        window.addEventListener('beforeunload', () => {
            saveCurrentPages();
        });

        // Start
        init();
    </script>
</body>
</html>